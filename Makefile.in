.SUFFIXES:
.SUFFIXES: .c .o

CC = @CC@
CFLAGS = @CFLAGS@ @XML_CFLAGS@ @CURL_CFLAGS@ @FUSE_CFLAGS@ @OPENSSL_CFLAGS@ @JSON_CFLAGS@
LDFLAGS = @LDFLAGS@
LIBS = @LIBS@ @XML_LIBS@ @CURL_LIBS@ @FUSE_LIBS@ @OPENSSL_LIBS@ @JSON_LIBS@ -lmagic
INSTALL = @INSTALL@
MKDIR_P = @MKDIR_P@
OBJDIR := .build
prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = $(DESTDIR)$(exec_prefix)/bin

SRC = $(wildcard *.c)
OBJS = $(SRC:%.c=$(OBJDIR)/%.o)
DEPS = $(SRC:%.c=$(OBJDIR)/%.d)

all: hubicfuse

install: all $(bindir)
	$(INSTALL) hubicfuse $(bindir)/hubicfuse

uninstall:
	/bin/rm -f $(bindir)/hubicfuse

$(bindir):
	$(MKDIR_P) $(bindir)
	
$(OBJDIR):
	$(MKDIR_P) $(OBJDIR)
	
$(OBJDIR)/%.o: %.c | $(OBJDIR)
	$(CC) -c -MMD $(CFLAGS) $< -o $@

-include $(DEPS)

hubicfuse: $(OBJS) | config.h
	$(CC) -o $@ $^ $(LIBS) $(LDFLAGS)

clean:
	/bin/rm -rf hubicfuse $(OBJDIR) *.orig

distclean: clean
	/bin/rm -rf Makefile config.h config.status config.cache config.log \
		autoscan.log configure.scan aclocal.m4 autom4te.cache stamp-h* marklib.dvi

mostlyclean: clean

maintainer-clean: clean

debug: CFLAGS += -g
debug: hubicfuse

configure: configure.ac
	autoconf
config.h.in: stamp-h.in
stamp-h.in: configure.ac
	autoheader
	echo timestamp > stamp-h.in

config.h: stamp-h
stamp-h: config.h.in config.status
	./config.status
Makefile: Makefile.in config.status
	./config.status
config.status: configure
	./config.status --recheck

reformat:
	astyle --style=allman \
		--convert-tabs \
		--indent=spaces=2 \
		--lineend=linux \
		--max-code-length=79 \
		--pad-oper \
		--pad-header \
		--align-pointer=type \
		--align-reference=name \
		--break-closing-brackets \
		--min-conditional-indent=0 \
		--remove-brackets \
		--remove-comment-prefix \
		*.c *.h
